openapi: 3.0.0
info:
  title: Black Relay API - OpenAPI 3.0
  version: 3.0.0
  description: The Black Relay API is used as the primary back end for the Black Relay web application. It is capable of subscribing to MQTT topics and storing messages published to those topics in a MongoDB collection.
  license:
    name: GPL v3.0
    url: 'https://www.gnu.org/licenses/gpl-3.0.en.html'
paths:
  /auth/login:
    post:
      tags:
        - auth
      summary: Log in to the API
      description: 'Logs in a user and returns a signed, httpOnly, session cookie'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                  example: joe.snuffy
                password:
                  type: string
                  example: P@$$Word123
              required:
                - username
                - password
      responses:
        '200':
          description: 'Successful login. Returns first name, last name, member group IDs and user ID.'
          content:
            application/json:
              schema:
                type: object
                properties:
                  firstName:
                    type: string
                    example: Joe
                  lastName:
                    type: string
                    example: Snuffy
                  groups:
                    type: array
                    example:
                      - 68de5378a3cc0665c0bbe3f2
                      - 68de53a9a3cc0665c0bbe3f3
                  user_id:
                    type: string
                    example: 68d72e98d951e85cf938a149
  /auth/logout:
    get:
      tags:
        - auth
      summary: Log out of the API
      description: Logs the user out and removes session cookie
      responses:
        '200':
          description: Successful logout
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
  /event:
    get:
      tags:
        - event
      summary: Get all events stored in DB
      description: Returns an array of objects containing event data from the MQTT topics
      responses:
        '200':
          description: Array of event objects
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    _id:
                      type: string
                      example: 671234567890abcdef123456
                    category:
                      type: string
                      enum:
                        - DETECT
                        - ALERT
                        - ALARM
                        - THREAT
                      example: DETECT
                      description: Event severity category
                    topic:
                      type: string
                      example: sensors/accelerometer/device01
                      description: MQTT topic where the event originated
                    data:
                      type: object
                      description: Event payload data - structure varies by topic
                      example:
                        x: 0.123
                        'y': -0.456
                        z: 9.789
                        timestamp: '2024-10-10T15:30:45.123Z'
                    createdAt:
                      type: string
                      format: date-time
                      example: '2024-10-10T15:30:45.123Z'
                      description: When the event was created in the database
                    updatedAt:
                      type: string
                      format: date-time
                      example: '2024-10-10T16:45:30.456Z'
                      description: When the event was last updated in the database
                    acknowledged:
                      type: boolean
                      example: false
                      description: Whether the event has been acknowledged by a user
                    __v:
                      type: integer
                      example: 0
                      description: MongoDB version field
        '500':
          description: Server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Events model not found
    post:
      tags:
        - event
      summary: Create a new event
      description: Creates a new event in the database with the provided data
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - category
                - topic
              properties:
                category:
                  type: string
                  enum:
                    - DETECT
                    - ALERT
                    - ALARM
                    - THREAT
                  description: Event severity category
                  example: DETECT
                topic:
                  type: string
                  description: MQTT topic where the event originated
                  example: sensors/accelerometer/device01
                data:
                  type: object
                  description: Event payload data - structure varies by topic
                  example:
                    x: 0.123
                    'y': -0.456
                    z: 9.789
                    timestamp: '2024-10-10T15:30:45.123Z'
      responses:
        '201':
          description: Event created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  _id:
                    type: string
                    example: 671234567890abcdef123456
                  category:
                    type: string
                    enum:
                      - DETECT
                      - ALERT
                      - ALARM
                      - THREAT
                    example: DETECT
                    description: Event severity category
                  topic:
                    type: string
                    example: sensors/accelerometer/device01
                    description: MQTT topic where the event originated
                  data:
                    type: object
                    description: Event payload data - structure varies by topic
                    example:
                      x: 0.123
                      'y': -0.456
                      z: 9.789
                      timestamp: '2024-10-10T15:30:45.123Z'
                  createdAt:
                    type: string
                    format: date-time
                    example: '2024-10-10T15:30:45.123Z'
                    description: When the event was created in the database
                  updatedAt:
                    type: string
                    format: date-time
                    example: '2024-10-10T15:30:45.123Z'
                    description: When the event was last updated in the database
                  acknowledged:
                    type: boolean
                    example: false
                    description: Whether the event has been acknowledged by a user (always false on creation)
                  __v:
                    type: integer
                    example: 0
                    description: MongoDB version field
        '400':
          description: Bad request - Invalid input data
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    examples:
                      missing_fields:
                        value: Category and topic are required fields
                      invalid_category:
                        value: 'Invalid event category. Must be one of: DETECT, ALERT, ALARM, THREAT'
                      validation_error:
                        value: Validation error
        '500':
          description: Server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Events model not found
  '/event/id/{eventId}':
    get:
      tags:
        - event
      summary: Get event by ID
      description: Returns a specific event by its MongoDB ObjectId
      parameters:
        - in: path
          name: eventId
          required: true
          schema:
            type: string
            pattern: '^[0-9a-fA-F]{24}$'
          description: MongoDB ObjectId of the event
          example: 671234567890abcdef123456
      responses:
        '200':
          description: Event object
          content:
            application/json:
              schema:
                type: object
                properties:
                  _id:
                    type: string
                    example: 671234567890abcdef123456
                  category:
                    type: string
                    enum:
                      - DETECT
                      - ALERT
                      - ALARM
                      - THREAT
                    example: DETECT
                    description: Event severity category
                  topic:
                    type: string
                    example: sensors/accelerometer/device01
                    description: MQTT topic where the event originated
                  data:
                    type: object
                    description: Event payload data - structure varies by topic
                    example:
                      x: 0.123
                      'y': -0.456
                      z: 9.789
                      timestamp: '2024-10-10T15:30:45.123Z'
                  createdAt:
                    type: string
                    format: date-time
                    example: '2024-10-10T15:30:45.123Z'
                    description: When the event was created in the database
                  updatedAt:
                    type: string
                    format: date-time
                    example: '2024-10-10T16:45:30.456Z'
                    description: When the event was last updated in the database
                  acknowledged:
                    type: boolean
                    example: false
                    description: Whether the event has been acknowledged by a user
                  __v:
                    type: integer
                    example: 0
                    description: MongoDB version field
        '400':
          description: Bad request - Invalid event ID format
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Invalid event ID format
        '404':
          description: Event not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Event not found
        '500':
          description: Server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Events model not found
    patch:
      tags:
        - event
      summary: Update event by ID
      description: Updates an existing event by its MongoDB ObjectId. Commonly used to acknowledge events or modify event data.
      parameters:
        - in: path
          name: eventId
          required: true
          schema:
            type: string
            pattern: '^[0-9a-fA-F]{24}$'
          description: MongoDB ObjectId of the event to update
          example: 671234567890abcdef123456
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                category:
                  type: string
                  enum:
                    - DETECT
                    - ALERT
                    - ALARM
                    - THREAT
                  description: Event severity category
                  example: ALERT
                topic:
                  type: string
                  description: MQTT topic where the event originated
                  example: sensors/accelerometer/device01
                data:
                  type: object
                  description: Event payload data - structure varies by topic
                  example:
                    x: 0.123
                    'y': -0.456
                    z: 9.789
                    timestamp: '2024-10-10T15:30:45.123Z'
                acknowledged:
                  type: boolean
                  description: Whether the event has been acknowledged by a user
                  example: true
              example:
                acknowledged: true
      responses:
        '200':
          description: Event updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  _id:
                    type: string
                    example: 671234567890abcdef123456
                  category:
                    type: string
                    enum:
                      - DETECT
                      - ALERT
                      - ALARM
                      - THREAT
                    example: DETECT
                    description: Event severity category
                  topic:
                    type: string
                    example: sensors/accelerometer/device01
                    description: MQTT topic where the event originated
                  data:
                    type: object
                    description: Event payload data - structure varies by topic
                    example:
                      x: 0.123
                      'y': -0.456
                      z: 9.789
                      timestamp: '2024-10-10T15:30:45.123Z'
                  createdAt:
                    type: string
                    format: date-time
                    example: '2024-10-10T15:30:45.123Z'
                    description: When the event was created in the database (immutable)
                  updatedAt:
                    type: string
                    format: date-time
                    example: '2024-10-10T17:15:22.789Z'
                    description: When the event was last updated in the database (automatically set)
                  acknowledged:
                    type: boolean
                    example: true
                    description: Whether the event has been acknowledged by a user
                  __v:
                    type: integer
                    example: 0
                    description: MongoDB version field
        '400':
          description: Bad request - Invalid input data or event ID
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    examples:
                      missing_id:
                        value: Event ID parameter is required
                      invalid_id:
                        value: Invalid event ID format
                      invalid_category:
                        value: 'Invalid event category. Must be one of: DETECT, ALERT, ALARM, THREAT'
                      validation_error:
                        value: Validation error
        '404':
          description: Event not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Event not found
        '500':
          description: Server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Events model not found
  '/event/topic/{topic}':
    get:
      tags:
        - event
      summary: Get events by topic
      description: Returns all events filtered by a specific MQTT topic
      parameters:
        - in: path
          name: topic
          required: true
          schema:
            type: string
          description: MQTT topic to filter events by
          example: sensors/accelerometer/device01
      responses:
        '200':
          description: Array of event objects matching the topic
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    _id:
                      type: string
                      example: 671234567890abcdef123456
                    category:
                      type: string
                      enum:
                        - DETECT
                        - ALERT
                        - ALARM
                        - THREAT
                      example: DETECT
                      description: Event severity category
                    topic:
                      type: string
                      example: sensors/accelerometer/device01
                      description: MQTT topic where the event originated
                    data:
                      type: object
                      description: Event payload data - structure varies by topic
                      example:
                        x: 0.123
                        'y': -0.456
                        z: 9.789
                        timestamp: '2024-10-10T15:30:45.123Z'
                    createdAt:
                      type: string
                      format: date-time
                      example: '2024-10-10T15:30:45.123Z'
                      description: When the event was created in the database
                    updatedAt:
                      type: string
                      format: date-time
                      example: '2024-10-10T16:45:30.456Z'
                      description: When the event was last updated in the database
                    acknowledged:
                      type: boolean
                      example: false
                      description: Whether the event has been acknowledged by a user
                    __v:
                      type: integer
                      example: 0
                      description: MongoDB version field
        '400':
          description: Bad request - Missing topic parameter
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Topic parameter is required
        '404':
          description: No events found for this topic
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: No events found for this topic
        '500':
          description: Server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Events model not found
  /event/before:
    get:
      tags:
        - event
      summary: Get events before timestamp
      description: 'Returns all events created before a specific timestamp, sorted by creation time (most recent first)'
      parameters:
        - in: query
          name: timestamp
          required: true
          schema:
            type: string
            format: date-time
          description: Timestamp to filter events before (ISO 8601 format recommended)
          example: '2024-10-10T15:30:45.123Z'
      responses:
        '200':
          description: Array of event objects created before the specified timestamp
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    _id:
                      type: string
                      example: 671234567890abcdef123456
                    category:
                      type: string
                      enum:
                        - DETECT
                        - ALERT
                        - ALARM
                        - THREAT
                      example: DETECT
                      description: Event severity category
                    topic:
                      type: string
                      example: sensors/accelerometer/device01
                      description: MQTT topic where the event originated
                    data:
                      type: object
                      description: Event payload data - structure varies by topic
                      example:
                        x: 0.123
                        'y': -0.456
                        z: 9.789
                        timestamp: '2024-10-10T15:30:45.123Z'
                    createdAt:
                      type: string
                      format: date-time
                      example: '2024-10-10T15:30:45.123Z'
                      description: When the event was created in the database
                    updatedAt:
                      type: string
                      format: date-time
                      example: '2024-10-10T16:45:30.456Z'
                      description: When the event was last updated in the database
                    acknowledged:
                      type: boolean
                      example: false
                      description: Whether the event has been acknowledged by a user
                    __v:
                      type: integer
                      example: 0
                      description: MongoDB version field
        '400':
          description: Bad request - Missing or invalid timestamp
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    examples:
                      missing:
                        value: Timestamp query parameter is required
                      invalid:
                        value: Invalid timestamp format
        '404':
          description: No events found before this timestamp
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: No events found before this timestamp
        '500':
          description: Server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Events model not found
  /event/after:
    get:
      tags:
        - event
      summary: Get events after timestamp
      description: 'Returns all events created after a specific timestamp, sorted by creation time (most recent first)'
      parameters:
        - in: query
          name: timestamp
          required: true
          schema:
            type: string
            format: date-time
          description: Timestamp to filter events after (ISO 8601 format recommended)
          example: '2024-10-10T15:30:45.123Z'
      responses:
        '200':
          description: Array of event objects created after the specified timestamp
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    _id:
                      type: string
                      example: 671234567890abcdef123456
                    category:
                      type: string
                      enum:
                        - DETECT
                        - ALERT
                        - ALARM
                        - THREAT
                      example: DETECT
                      description: Event severity category
                    topic:
                      type: string
                      example: sensors/accelerometer/device01
                      description: MQTT topic where the event originated
                    data:
                      type: object
                      description: Event payload data - structure varies by topic
                      example:
                        x: 0.123
                        'y': -0.456
                        z: 9.789
                        timestamp: '2024-10-10T15:30:45.123Z'
                    createdAt:
                      type: string
                      format: date-time
                      example: '2024-10-10T15:30:45.123Z'
                      description: When the event was created in the database
                    updatedAt:
                      type: string
                      format: date-time
                      example: '2024-10-10T16:45:30.456Z'
                      description: When the event was last updated in the database
                    acknowledged:
                      type: boolean
                      example: false
                      description: Whether the event has been acknowledged by a user
                    __v:
                      type: integer
                      example: 0
                      description: MongoDB version field
        '400':
          description: Bad request - Missing or invalid timestamp
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    examples:
                      missing:
                        value: Timestamp query parameter is required
                      invalid:
                        value: Invalid timestamp format
        '404':
          description: No events found after this timestamp
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: No events found after this timestamp
        '500':
          description: Server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Events model not found
  '/topic/{topic}/subscribe':
    get:
      tags:
        - topic
      summary: Subscribe to an MQTT topic
      description: Stores published messages to a corresponding MongoDB collection
      parameters:
        - name: topic
          in: path
          required: true
          schema:
            type: string
          description: The MQTT topic to subscribe to
      responses:
        '200':
          description: Subscribe to topic
          content:
            application/json:
              schema:
                type: object
                properties:
                  test:
                    type: string
                    example: example
  /user:
    get:
      tags:
        - user
      summary: Get all users stored in DB
      description: Returns an array of objects containing user data
      responses:
        '200':
          description: Example user data
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    userId:
                      type: integer
                      example: 1
                    firstName:
                      type: string
                      example: Joe
                    lastName:
                      type: string
                      example: Snuffy
                    username:
                      type: string
                      example: joe.snuffy
                    password:
                      type: string
                      example: $2b$10$EIXZQ1ZQ1ZQ1ZQ1ZQ1ZQ1O$2b$10$OOwh82PRs69t8INcue0fiOKbsLkVVIoe4Ib0DFMDJRn3j0cO0/X5C
                    createdAt:
                      type: string
                      example: '2024-06-11T14:23:45.123Z'
    post:
      tags:
        - user
      summary: Create a new user
      description: Creates a new user in the database
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                firstName:
                  type: string
                  example: Joe
                  required: false
                lastName:
                  type: string
                  example: Snuffy
                  required: false
                username:
                  type: string
                  example: joe.snuffy
                  required: true
                password:
                  type: string
                  example: plainTextPassword
                  required: true
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  userId:
                    type: string
                    example: 68de4b75ee5dce28c22bfb64
                  firstName:
                    type: string
                    example: Joe
                  lastName:
                    type: string
                    example: Snuffy
                  username:
                    type: string
                    example: joe.snuffy
                  password:
                    type: string
                    example: $2b$10$EIXZQ1ZQ1ZQ1ZQ1ZQ1ZQ1O$2b$10$kX8FxF2fg6toWdHMR2BnLenR1SpmDcNpRi/3g8NB5snbGyYmi4wPi
                  createdAt:
                    type: string
                    example: '2024-06-11T14:23:45.123Z'
    delete:
      tags:
        - user
      summary: Delete a user by user ID
      description: Deletes a user from the database
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
          example: 68de4b75ee5dce28c22bfb64
      responses:
        '200':
          description: User deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: User deleted successfully
  '/user/{userId}':
    get:
      tags:
        - user
      summary: Get user info stored in DB by user ID
      description: Returns an object containing user data
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
          example: 68de4b75ee5dce28c22bfb64
      responses:
        '200':
          description: Example user data
          content:
            application/json:
              schema:
                type: object
                properties:
                  userId:
                    type: string
                    example: 68de4b75ee5dce28c22bfb64
                  firstName:
                    type: string
                    example: Joe
                  lastName:
                    type: string
                    example: Snuffy
                  username:
                    type: string
                    example: joe.snuffy
                  password:
                    type: string
                    example: $2b$10$EIXZQ1ZQ1ZQ1ZQ1ZQ1ZQ1O$2b$10$OOwh82PRs69t8INcue0fiOKbsLkVVIoe4Ib0DFMDJRn3j0cO0/X5C
                  createdAt:
                    type: string
                    example: '2024-06-11T14:23:45.123Z'
    patch:
      tags:
        - user
      summary: Update user info stored in DB by user ID
      description: Updates user data in the database
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
          example: 68de4b75ee5dce28c22bfb64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                firstName:
                  type: string
                  example: Joe
                  required: false
                lastName:
                  type: string
                  example: Snuffy
                  required: false
                username:
                  type: string
                  example: joe.snuffy
                  required: false
                password:
                  type: string
                  example: $2b$10$EIXZQ1ZQ1ZQ1ZQ1ZQ1O$2b$10$OOwh82PRs69t8INcue0fiOKbsLkVVIoe4Ib0DFMDJRn3j0cO0/X5C
                  required: false
      responses:
        '200':
          description: Example updated user data
          content:
            application/json:
              schema:
                type: object
                properties:
                  userId:
                    type: string
                    example: 68de4b75ee5dce28c22bfb64
                  firstName:
                    type: string
                    example: Joe
                  lastName:
                    type: string
                    example: Snuffy
                  username:
                    type: string
                    example: joe.snuffy
                  password:
                    type: string
                    example: $2b$10$EIXZQ1ZQ1ZQ1ZQ1ZQ1O$2b$10$OOwh82PRs69t8INcue0fiOKbsLkVVIoe4Ib0DFMDJRn3j0cO0/X5C
                  createdAt:
                    type: string
                    example: '2024-06-11T14:23:45.123Z'
